######################################################################################################
## This file includes scripted effects for the war room and general scripted effects for operations ##
######################################################################################################

# usage:
## update_war_room_window = yes
update_war_room_window = {
	if = {
		limit = {
			has_variable = show_war_room_window
		}
		if = {
			limit = {
				check_variable = { show_war_room_window > 1000 }
			}
			set_variable = { show_war_room_window = 0 }
		}
		add_to_variable = { show_war_room_window = 1 }
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## collapse_war_room_operation_tab = yes
collapse_war_room_operation_tab = {
	meta_effect = {
		text = {
			set_country_flag = has_minimized_war_room_operation_[ID]
		}
		ID = "[?operation_id]"
	}
	update_war_room_window = yes
}

# usage:
## set_temp_variable = { operation_id = 1 }
## expand_war_room_operation_tab = yes
expand_war_room_operation_tab = {
	meta_effect = {
		text = {
			clr_country_flag = has_minimized_war_room_operation_[ID]
		}
		ID = "[?operation_id]"
	}
	update_war_room_window = yes
}

# usage:
## set_temp_variable = { operation_id = 1 }
## select_decisions_tab_for_war_room_operation = yes
select_decisions_tab_for_war_room_operation = {
	meta_effect = {
		text = {
			set_country_flag = has_selected_decisions_tab_war_room_operation_[ID]
		}
		ID = "[?operation_id]"
	}
	update_war_room_window = yes
}

# usage:
## set_temp_variable = { operation_id = 1 }
## deselect_decisions_tab_for_war_room_operation = yes
deselect_decisions_tab_for_war_room_operation = {
	meta_effect = {
		text = {
			clr_country_flag = has_selected_decisions_tab_war_room_operation_[ID]
		}
		ID = "[?operation_id]"
	}
	update_war_room_window = yes
}

# usage:
## set_temp_variable = { operation_id = 1 }
## add_possible_war_room_operation = yes
add_possible_war_room_operation = {
	if = {
		limit = {
			has_not_possible_war_room_operation = yes
		}
		custom_effect_tooltip = ADD_POSSIBLE_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			meta_effect = {
				text = {
					if = {
						limit = {
							check_variable = { global.war_room_operation_[ID]_decisions_array^num < 1 }
						}
						set_up_decisions_for_war_room_operation_[ID] = yes
					}
				}
				ID = "[?operation_id]"
			}
			add_to_array = { possible_war_room_operations_array = operation_id }
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## remove_possible_war_room_operation = yes
remove_possible_war_room_operation = {
	if = {
		limit = {
			has_possible_war_room_operation = yes
		}
		custom_effect_tooltip = REMOVE_POSSIBLE_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			if = {
				limit = {
					has_active_war_room_operation = yes
				}
				remove_active_war_room_operation = yes
			}
			remove_from_array = { possible_war_room_operations_array = operation_id }
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## add_active_war_room_operation = yes
add_active_war_room_operation = {
	if = {
		limit = {
			has_possible_war_room_operation = yes
			has_not_active_war_room_operation = yes
		}
		custom_effect_tooltip = ADD_ACTIVE_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			add_to_array = { active_war_room_operations_array = operation_id }
			set_temp_variable = { amount = 0 }
			set_war_room_operation_progress = yes
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## remove_active_war_room_operation = yes
remove_active_war_room_operation = {
	if = {
		limit = {
			has_active_war_room_operation = yes
		}
		custom_effect_tooltip = REMOVE_ACTIVE_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			expand_war_room_operation_tab = yes
			meta_effect = {
				text = {
					clear_variable = war_room_operation_[ID]_progress
					clear_variable = war_room_operation_[ID]_used_generals_amount
					clear_array = war_room_operation_[ID]_pre_launch_assigned_generals_array
					clr_country_flag = has_launched_war_room_operation_[ID]
				}
				ID = "[?operation_id]"
			}
			remove_from_array = { active_war_room_operations_array = operation_id }
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { no_tooltip = 1 } # optional
## complete_war_room_operation = yes
complete_war_room_operation = {
	if = {
		limit = {
			has_possible_war_room_operation = yes
			has_not_completed_war_room_operation = yes
			has_not_failed_war_room_operation = yes
		}
		if = {
			limit = {
				NOT = { check_variable = { no_tooltip = 1 } }
			}
			custom_effect_tooltip = COMPLETE_WAR_ROOM_OPERATION_TT
		}
		meta_effect = {
			text = {
				complete_war_room_operation_[ID] = yes
				hidden_effect = {
					set_country_flag = has_completed_war_room_operation_[ID]
				}
			}
			ID = "[?operation_id]"
		}
		hidden_effect = {
			if = {
				limit = {
					has_active_war_room_operation = yes
				}
				remove_active_war_room_operation = yes
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { no_tooltip = 1 } # optional
## fail_war_room_operation = yes
fail_war_room_operation = {
	if = {
		limit = {
			has_possible_war_room_operation = yes
			has_not_completed_war_room_operation = yes
			has_not_failed_war_room_operation = yes
		}
		if = {
			limit = {
				NOT = { check_variable = { no_tooltip = 1 } }
			}
			custom_effect_tooltip = FAIL_WAR_ROOM_OPERATION_TT
		}
		meta_effect = {
			text = {
				fail_war_room_operation_[ID] = yes
				hidden_effect = {
					set_country_flag = has_failed_war_room_operation_[ID]
				}
			}
			ID = "[?operation_id]"
		}
		hidden_effect = {
			if = {
				limit = {
					has_active_war_room_operation = yes
				}
				remove_active_war_room_operation = yes
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## launch_war_room_operation = yes
launch_war_room_operation = {
	if = {
		limit = {
			has_active_war_room_operation = yes
			has_not_launched_war_room_operation = yes
		}
		custom_effect_tooltip = LAUNCH_WAR_ROOM_OPERATION_TT
		if = {
			limit = {
				OR = {
					AND = {
						has_war_room_operation_progress_phase_1 = yes
						is_war_room_operation_progress_phase_1_active = yes
					}
					AND = {
						has_war_room_operation_progress_phase_2 = yes
						is_war_room_operation_progress_phase_2_active = yes
					}
					AND = {
						has_war_room_operation_progress_phase_3 = yes
						is_war_room_operation_progress_phase_3_active = yes
					}
					AND = {
						has_war_room_operation_progress_phase_4 = yes
						is_war_room_operation_progress_phase_4_active = yes
					}
				}
			}
			custom_effect_tooltip = LAUNCH_WAR_ROOM_OPERATION_PHASES_TT
			if = {
				limit = {
					has_war_room_operation_progress_phase_4 = yes
					is_war_room_operation_progress_phase_4_active = yes
				}
				execute_war_room_operation_progress_phase_4_effect = yes
			}
			else_if = {
				limit = {
					has_war_room_operation_progress_phase_3 = yes
					is_war_room_operation_progress_phase_3_active = yes
				}
				execute_war_room_operation_progress_phase_3_effect = yes
			}
			else_if = {
				limit = {
					has_war_room_operation_progress_phase_2 = yes
					is_war_room_operation_progress_phase_2_active = yes
				}
				execute_war_room_operation_progress_phase_2_effect = yes
			}
			else = {
				execute_war_room_operation_progress_phase_1_effect = yes
			}
			custom_effect_tooltip = LAUNCH_WAR_ROOM_OPERATION_PHASES_TT_EMPTY_LINE
		}
		hidden_effect = {
			meta_effect = {
				text = {
					clear_array = war_room_operation_[ID]_pre_launch_assigned_generals_array
					for_each_loop = {
						array = war_room_operation_[ID]_assigned_generals_array
						value = value_temp
						index = index_temp
						add_to_array = { war_room_operation_[ID]_pre_launch_assigned_generals_array = value_temp }
					}
					set_country_flag = has_launched_war_room_operation_[ID]
				}
				ID = "[?operation_id]"
			}
			unassign_all_generals_from_war_room_operation = yes
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { general_id = 1 }
## assign_general_to_war_room_operation = yes
assign_general_to_war_room_operation = {
	if = {
		limit = {
			has_active_war_room_operation = yes
			set_temp_variable = { amount = 4 }
			has_less_amount_of_war_room_operation_assigned_generals = yes
			is_not_general_assigned_to_war_room_operation = yes
		}
		custom_effect_tooltip = ASSIGN_GENERAL_TO_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			meta_effect = {
				text = {
					add_to_array = { war_room_operation_[ID]_assigned_generals_array = general_id }
				}
				ID = "[?operation_id]"
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { general_id = 1 }
## unassign_general_from_war_room_operation = yes
unassign_general_from_war_room_operation = {
	if = {
		limit = {
			is_general_assigned_to_war_room_operation = yes
		}
		custom_effect_tooltip = UNASSIGN_GENERAL_FROM_WAR_ROOM_OPERATION_TT
		hidden_effect = {
			meta_effect = {
				text = {
					remove_from_array = { war_room_operation_[ID]_assigned_generals_array = general_id }
				}
				ID = "[?operation_id]"
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## assign_random_general_to_war_room_operation = yes
assign_random_general_to_war_room_operation = {
	hidden_effect = {
		random_scope_in_array = {
			array = army_leaders
			limit = {
				set_temp_variable = { general_id = THIS.id }
				ROOT = {
					is_not_general_assigned_to_any_war_room_operation = yes
				}
			}
			set_temp_variable = { general_id = THIS.id }
		}
	}
	assign_general_to_war_room_operation = yes
}

# usage:
## set_temp_variable = { operation_id = 1 }
## unassign_all_generals_from_war_room_operation = yes
unassign_all_generals_from_war_room_operation = {
	custom_effect_tooltip = UNASSIGN_ALL_GENERALS_FROM_WAR_ROOM_OPERATION_TT
	hidden_effect = {
		clear_temp_array = war_room_operation_assigned_generals_array_temp
		meta_effect = {
			text = {
				for_each_loop = {
					array = war_room_operation_[ID]_assigned_generals_array
					value = value_temp
					index = index_temp
					add_to_temp_array = { war_room_operation_assigned_generals_array_temp = value_temp }
				}
				for_each_loop = {
					array = war_room_operation_assigned_generals_array_temp
					value = value_temp
					index = index_temp
					set_temp_variable = { general_id = value_temp }
					unassign_general_from_war_room_operation = yes
				}
				clear_array = war_room_operation_[ID]_assigned_generals_array
			}
			ID = "[?operation_id]"
		}
		clear_temp_array = war_room_operation_assigned_generals_array_temp
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { general_id = 1 }
## unassign_all_unavailable_generals_from_all_war_room_operations = yes
unassign_all_unavailable_generals_from_all_war_room_operations = {
	hidden_effect = {
		if = {
			limit = {
				set_temp_variable = { amount = 1 }
				has_amount_of_active_war_room_operations = yes
			}
			for_each_loop = {
				array = active_war_room_operations_array
				value = value_temp_temp
				index = index_temp_temp
				set_temp_variable = { operation_id = value_temp_temp }
				if = {
					limit = {
						set_temp_variable = { amount = 1 }
						has_amount_of_war_room_operation_assigned_generals = yes
					}
					clear_temp_array = war_room_operation_assigned_generals_array_temp
					meta_effect = {
						text = {
							for_each_loop = {
								array = war_room_operation_[ID]_assigned_generals_array
								value = value_temp
								index = index_temp
								add_to_temp_array = { war_room_operation_assigned_generals_array_temp = value_temp }
							}
						}
						ID = "[?operation_id]"
					}
					for_each_loop = {
						array = war_room_operation_assigned_generals_array_temp
						value = value_temp
						index = index_temp
						set_temp_variable = { general_id = value_temp }
						if = {
							limit = {
								NOT = { is_in_array = { army_leaders = general_id } }
							}
							unassign_general_from_war_room_operation = yes
						}
					}
					clear_temp_array = war_room_operation_assigned_generals_array_temp
				}
			}
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { amount = 1 }
## set_war_room_operation_progress = yes
set_war_room_operation_progress = {
	if = {
		limit = {
			has_active_war_room_operation = yes
		}
		custom_effect_tooltip = SET_WAR_ROOM_OPERATION_PROGRESS_TT
		hidden_effect = {
			meta_effect = {
				text = {
					add_to_variable = { war_room_operation_[ID]_progress = amount }
					clamp_variable = {
						var = war_room_operation_[ID]_progress
						min = 0
						max = 100
					}
				}
				ID = "[?operation_id]"
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { amount = 1 }
## add_war_room_operation_progress = yes
add_war_room_operation_progress = {
	if = {
		limit = {
			has_active_war_room_operation = yes
		}
		custom_effect_tooltip = ADD_WAR_ROOM_OPERATION_PROGRESS_TT
		hidden_effect = {
			meta_effect = {
				text = {
					add_to_variable = { war_room_operation_[ID]_progress = amount }
					clamp_variable = {
						var = war_room_operation_[ID]_progress
						min = 0
						max = 100
					}
				}
				ID = "[?operation_id]"
			}
			update_war_room_window = yes
		}
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { decision_id = token:name }
## execute_complete_effect_war_room_operation_decision = yes
execute_complete_effect_war_room_operation_decision = {
	meta_effect = {
		text = {
			war_room_operation_decision_complete_effect_[ID] = yes
		}
		ID = "[?decision_id.GetTokenKey]"
	}
	if = {
		limit = {
			calculate_war_room_operation_decision_cost = yes
		}
		if = {
			limit = {
				check_variable = { cp_cost > 0 }
				check_variable = { generals_cost > 0 }
			}
			custom_effect_tooltip = EXECUTE_COMPLETE_EFFECT_WAR_ROOM_OPERATION_DECISION_TT_COST_CP_AND_GENERALS
		}
		else_if = {
			limit = {
				check_variable = { cp_cost > 0 }
			}
			custom_effect_tooltip = EXECUTE_COMPLETE_EFFECT_WAR_ROOM_OPERATION_DECISION_TT_COST_CP
		}
		else_if = {
			limit = {
				check_variable = { generals_cost > 0 }
			}
			custom_effect_tooltip = EXECUTE_COMPLETE_EFFECT_WAR_ROOM_OPERATION_DECISION_TT_COST_GENERALS
		}
		hidden_effect = {
			set_temp_variable = { cp_cost_temp = cp_cost }
			multiply_temp_variable = { cp_cost_temp = -1 }
			add_command_power = cp_cost_temp
			meta_effect = {
				text = {
					add_to_variable = { war_room_operation_[ID]_used_generals_amount = generals_cost }
					set_temp_variable = { temp = war_room_operation_[ID]_assigned_generals_array^num }
					clamp_variable = {
						var = war_room_operation_[ID]_used_generals_amount
						min = 0
						max = temp
					}
				}
				ID = "[?operation_id]"
			}
		}
	}
	hidden_effect = {
		if = {
			limit = {
				is_not_war_room_operation_decision_completed = yes
			}
			add_to_array = { war_room_operation_completed_decisions_array = decision_id }
		}
		update_war_room_window = yes
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { decision_id = token:name }
## execute_remove_effect_war_room_operation_decision = yes
execute_remove_effect_war_room_operation_decision = {
	meta_effect = {
		text = {
			war_room_operation_decision_remove_effect_[ID] = yes
		}
		ID = "[?decision_id.GetTokenKey]"
	}
	hidden_effect = {
		if = {
			limit = {
				calculate_war_room_operation_decision_cost = yes
			}
			meta_effect = {
				text = {
					subtract_from_variable = { war_room_operation_[ID]_used_generals_amount = generals_cost }
					set_temp_variable = { temp = war_room_operation_[ID]_assigned_generals_array^num }
					clamp_variable = {
						var = war_room_operation_[ID]_used_generals_amount
						min = 0
						max = temp
					}
				}
				ID = "[?operation_id]"
			}
		}
		update_war_room_window = yes
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## set_temp_variable = { decision_id = token:name }
## execute_cancel_effect_war_room_operation_decision = yes
execute_cancel_effect_war_room_operation_decision = {
	meta_effect = {
		text = {
			war_room_operation_decision_cancel_effect_[ID] = yes
		}
		ID = "[?decision_id.GetTokenKey]"
	}
	hidden_effect = {
		if = {
			limit = {
				calculate_war_room_operation_decision_cost = yes
			}
			meta_effect = {
				text = {
					subtract_from_variable = { war_room_operation_[ID]_used_generals_amount = generals_cost }
					set_temp_variable = { temp = war_room_operation_[ID]_assigned_generals_array^num }
					clamp_variable = {
						var = war_room_operation_[ID]_used_generals_amount
						min = 0
						max = temp
					}
				}
				ID = "[?operation_id]"
			}
		}
		if = {
			limit = {
				is_war_room_operation_decision_completed = yes
			}
			remove_from_array = { war_room_operation_completed_decisions_array = decision_id }
		}
		update_war_room_window = yes
	}
}

# usage:
## set_temp_variable = { show_tooltip = 1 } # optional
## show_complete_effect_war_room_operation_decision_general_tooltip = yes
show_complete_effect_war_room_operation_decision_general_tooltip = {
	if = {
		limit = {
			check_variable = { show_tooltip = 1 }
		}
		custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_COMPLETE_EFFECT_TT
	}
}

# usage:
## set_temp_variable = { show_tooltip = 1 } # optional
## show_remove_effect_war_room_operation_decision_general_tooltip = yes
show_remove_effect_war_room_operation_decision_general_tooltip = {
	if = {
		limit = {
			check_variable = { show_tooltip = 1 }
		}
		if = {
			limit = {
				check_variable = { days_remove = -1 }
			}
			custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_REMOVE_EFFECT_TT_ENDLESS
		}
		else = {
			if = {
				limit = {
					is_war_room_operation_decision_in_progress = yes
				}
				custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_REMOVE_EFFECT_TT_ACTIVE
			}
			else = {
				custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_REMOVE_EFFECT_TT_INACTIVE
			}
		}
		custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_REMOVE_EFFECT_TT
	}
}

# usage:
## set_temp_variable = { show_tooltip = 1 } # optional
## show_cancel_effect_war_room_operation_decision_general_tooltip = yes
show_cancel_effect_war_room_operation_decision_general_tooltip = {
	if = {
		limit = {
			check_variable = { show_tooltip = 1 }
		}
		custom_effect_tooltip = WAR_ROOM_OPERATION_DECISION_CANCEL_EFFECT_TT
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## execute_war_room_operation_progress_phase_1_effect = yes
execute_war_room_operation_progress_phase_1_effect = {
	meta_effect = {
		text = {
			execute_progress_phase_1_effect_for_war_room_operation_[ID] = yes
		}
		ID = "[?operation_id]"
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## execute_war_room_operation_progress_phase_2_effect = yes
execute_war_room_operation_progress_phase_2_effect = {
	meta_effect = {
		text = {
			execute_progress_phase_2_effect_for_war_room_operation_[ID] = yes
		}
		ID = "[?operation_id]"
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## execute_war_room_operation_progress_phase_3_effect = yes
execute_war_room_operation_progress_phase_3_effect = {
	meta_effect = {
		text = {
			execute_progress_phase_3_effect_for_war_room_operation_[ID] = yes
		}
		ID = "[?operation_id]"
	}
}

# usage:
## set_temp_variable = { operation_id = 1 }
## execute_war_room_operation_progress_phase_4_effect = yes
execute_war_room_operation_progress_phase_4_effect = {
	meta_effect = {
		text = {
			execute_progress_phase_4_effect_for_war_room_operation_[ID] = yes
		}
		ID = "[?operation_id]"
	}
}